<?
error_reporting(E_ALL ^ E_NOTICE);
 ini_set ("memory_limit","1096M");

include("teststudio.php");
$lang="en";

function import_xml ($file_name,$xml_type,$insert_to_db=0,$test_id='',$topic_id='') {
global $lang,$yaz;
if (@!($xml = join("",file("$file_name")))) {echo "file error<br>";}
else {
	$xml=iconv("windows-1251","utf-8",$xml);
	$xml=preg_replace("/encoding=\"(.*)\"/","encoding=\"utf-8\" ",$xml);
    if (@!$dom=domxml_open_mem($xml) or !$dom->document_element() ) {echo "error while parsing XML<br>";}
    else {
        $root = $dom->document_element();
        if ($root->tagname()!=$xml_type) 
            {echo $yaz['tstudio']['xml_wrong_xml1'][$lang]." (".$root->tagname().")".$yaz['tstudio']['xml_wrong_xml2'][$lang]." $xml_type";}
        else {
            echo "<table border=1 cellpadding=0 cellspacing=0>";
            switch ($root->tagname())

                {
                case 'questions': {echo "this is questions XML. Only tests are supported<br>";
                					break;}
                case 'topics': {echo "this is topic XML.  Only tests are supported<br>";
                				break;}
                case 'test': {echo "this is test XML<br>";get_tests_from_xml ($root,$insert_to_db);break;}

                default: {echo "unknown XML";break;}
                }
            echo "</table>";
             }
         }
     }

if ($root) {$root->unlink_node();}
                                }
//-------------------------------

function get_tests_from_xml ($root,$insert_to_db) {
global $mysql_dbname,$_COOKIE,$lang,$yaz;

$test_name=$root->get_elements_by_tagname('test_name'); 
$topics=$root->get_elements_by_tagname('topics'); 

if($test_name[0]!="") 
    {
    $name_content_error="";
    $name=$test_name[0];
	$name_content=$name->get_content();
    if ($name_content=="")
        {$name_content_error=$yaz['tstudio']['xml_test_name_absent'][$lang];}
    }
else {$name_content_error="tag TEST_NAME absent";$name_content="";}

$topic_nodes='';
$check_topics_root=$topics[0];
if($check_topics_root!="")
    {$topic_nodes=$check_topics_root->get_elements_by_tagname('topic'); }
if($topic_nodes[0]=="") 
    {$topics_error= "<tr>
    <td colspan=6>��� ���!</td></tr>";}
else {$topics_error="";}

echo "<tr><td colspan=5><b>test name: $name_content <span class='error'>$name_content_error</span> </b></td>
<td>";

if($name_content_error=="")
    {
    if ($insert_to_db==1)
        {
        $test_category_id=$GLOBALS['test_category_id'];
		$name_content = mysql_real_escape_string($name_content);
        $valid_test_name=check_test_name($test_category_id,$name_content);
		sql_query("insert into tests
                        (test_id,test_category_id,test_name,test_disable)
                        values
                        ('','$test_category_id','$valid_test_name','0')
                        ");
        $ins_test_id=mysql_insert_id();
		$GLOBALS['dirpath']=$GLOBALS['config']['opentest_root_path']."/media/test_".$ins_test_id."/";
		mkdir($GLOBALS['dirpath'], 0777);
		$GLOBALS['prefix']=$GLOBALS['config']['media_path_prefix'].$ins_test_id."/";
		
		$query="INSERT into permissions (object_code,object_id,user_id,permission_owner)
              VALUES ('12','".$ins_test_id."','".$GLOBALS['auth_result']['user']['user_id']."','1') ";
              sql_query($query);
        }
    else {
    $ins_test_id="";

                        $rnd=rand(0,100000000000000);
                        $dirpath1="/tmp/".$GLOBALS['auth_result']['user']['user_id']."/archive_".$rnd."/";
                        $GLOBALS['dirpath']=dirname(__FILE__)."/../".$dirpath1;

                        $user_dir=dirname(__FILE__)."/../tmp/".$GLOBALS['auth_result']['user']['user_id'];

                        include(dirname(__FILE__)."/../dirtool/class_dirtool.php");
                        @mkdir($user_dir, 0777);   


			$dir = @new dirtool($user_dir);
                        @$dir->delete();

                        mkdir($user_dir, 0777);
                        mkdir($GLOBALS['dirpath'], 0777);
                        $GLOBALS['prefix']="modules/tests/include".$dirpath1;


    echo $yaz['tstudio']['xml_correct'][$lang];}
    }
else {echo "<span class='error'>".$yaz['tstudio']['xml_incorrect'][$lang]."</span>";}

echo "</td></tr> $topics_error";
if ($topics_error=="" and $name_content_error=="")
    {get_topics_from_xml($topics[0],$ins_test_id,$insert_to_db); }
elseif ($topics_error=="") 
    {get_topics_from_xml($topics[0],$ins_test_id,0); }

    }

function get_topics_from_xml ($root,$test_id,$insert_to_db) {
global $mysql_dbname,$lang,$yaz;
$check_topic_name_xml=array();
$topic_nodes=$root->get_elements_by_tagname('topic'); 
foreach($topic_nodes as $topic_node)
    {
$topic_name=$topic_node->get_elements_by_tagname('topic_name'); 
$questions=$topic_node->get_elements_by_tagname('questions'); 
if($topic_name[0]!="") 
    {
    $name_content_error="";
    $name=$topic_name[0];$name_content=$name->get_content();
    if ($name_content=="")
        {$name_content_error=$yaz['tstudio']['xml_topic_name_absent'][$lang];}
    }
else {$name_content_error="tag TOPIC_NAME absent";$name_content="";}

$question_nodes='';
$check_questions_root=$questions[0];
if($check_questions_root!="")
    {$question_nodes=$check_questions_root->get_elements_by_tagname('question'); }
if($question_nodes[0]=="") 
    {$questions_error= "<tr><td>&nbsp;&nbsp;&nbsp;</td>
    <td colspan=5><span class='error'>".$yaz['tstudio']['xml_no_qestions'][$lang]."</span></td></tr>";}
else {$questions_error="";}

echo "<tr><td colspan=5><b>topic name: $name_content <span class='error'>$name_content_error</span> </b></td>
<td>";

$ins_topic_id="";
if ($name_content_error=="")
    {
    $check_topic_name_xml[]=$name_content;
	$name_content = mysql_real_escape_string($name_content);
    if ($insert_to_db==1)
        {
         sql_query("insert into topics
                    (topic_id,test_id,topic_name,topic_disable)
                    values
                    ('','$test_id','$name_content','0')
                    ");
        $ins_topic_id=mysql_insert_id();
            echo $yaz['tstudio']['xml_written_topic'][$lang];
        }
    else {echo $yaz['tstudio']['xml_correct_topic'][$lang];}
    }

else {echo "<span class='error'>".$yaz['tstudio']['xml_incorrect_topic'][$lang]."</span>";}

echo "</td></tr> $questions_error";
if ($questions_error=="" and $name_content_error=="")
    { get_questions_from_xml($questions[0],$ins_topic_id,$insert_to_db);}
elseif ($questions_error=="") 
    { get_questions_from_xml($questions[0],$ins_topic_id,0);}


  }
      }

function get_questions_from_xml ($root,$topic_id,$insert_to_db) {
global $mysql_dbname,$lang,$yaz;

$question_nodes=$root->get_elements_by_tagname('question'); 
foreach($question_nodes as $question_node)
    {
$question_type=$question_node->get_elements_by_tagname('question_type'); 
$question_text=$question_node->get_elements_by_tagname('question_text'); 
$answers=$question_node->get_elements_by_tagname('answers'); 
         $result_insert_temp=sql_query("insert into questions
                    (question_id,topic_id,question_text,question_type,question_disable,show_later,question_difficulty)
                    values
                    ('','','','',
                    '','','1')
                    ");
         $result_temp_id=mysql_insert_id();

if($question_type[0]!="") 
    {
    $type=$question_type[0];$type_content=$type->get_content();
    $types=array("1","2","3","4");
    if (in_array($type_content,$types)!=1) 
        {$question_type_error=$yaz['tstudio']['xml_wrong_q_type'][$lang];}
    }
else {$question_type_error="tag QUESTION_TYPE is absent!";$type_content="";}
if($question_text[0]!="") 
    {
    $text=$question_text[0];$text_content=$text->get_content();
    $text_content=check_for_pics('question',$result_temp_id,$text_content,$insert_to_db);
    //echo "---";print_r($text_content);echo "---";
    if ($text_content=="") 
        {$question_text_error=$yaz['tstudio']['xml_no_q_text'][$lang];}
    else {$question_text_error="";}
    }
else {$question_text_error="tag QUESTION_TEXT is absent";$text_content="";}

$answer_nodes='';
$check_answers_root=$answers[0];
if($check_answers_root!="")
{ $answer_nodes=$check_answers_root->get_elements_by_tagname('answer'); }
if($answer_nodes[0]=="") 
    {$answers_error= "<tr><td>&nbsp;&nbsp;&nbsp;</td><td>&nbsp;&nbsp;&nbsp;</td>
    <td colspan=4>".$yaz['tstudio']['xml_no_answers'][$lang]."</td></tr>";}
else {$answers_error="";

	$check_right_answers=$answers[0];
	$answer_nodes=$check_right_answers->get_elements_by_tagname('answer'); 
	$answers_error="<tr><td>&nbsp;&nbsp;&nbsp;</td><td>&nbsp;&nbsp;&nbsp;</td>
    <td colspan=4><span class='error'>".$yaz['tstudio']['xml_no_right_answers'][$lang]."</span></td></tr>";
    $true_present=0;
	foreach($answer_nodes as $answer_node)
		{
		$answer_true=$answer_node->get_elements_by_tagname('true'); 
		if($answer_true[0]!="") 
    		{$true=$answer_true[0];$true_content=$true->get_content();
    		if ($true_content=="1") 
    			{
    			if ($type_content=="1" and $true_present==1)
    				{
    				$answers_error="<tr><td>&nbsp;&nbsp;&nbsp;</td><td>&nbsp;&nbsp;&nbsp;</td>
    <td colspan=4><span class='error'>".$yaz['tstudio']['xml_for1st_type'][$lang]."</span></td></tr>";$true_present=1;
    				}
    			else
    				{$answers_error='';$true_present=1;}
    			}
    		}
		}
 	 }
//--------

$delayed=$question_node->get_attribute("delayed");
if ($delayed=='1')
    {
    $delayed_str="30";
    }
else {$delayed_str="0";}


echo "<tr><td>&nbsp;&nbsp;&nbsp; </td>



<td colspan=3><b>question text: $text_content $question_text_error </b></td>
<td>type: $type_content $question_type_error </td><td>";
    if ($insert_to_db==1 and $question_type_error=="" 
        and $question_text_error=="" and $answers_error=="")
        {

        $result_insert_question=sql_query("
        update questions set
        topic_id='$topic_id',question_text='".addslashes($text_content)."',
        question_type='$type_content',question_disable=0,
        show_later='$delayed_str'
        where question_id='$result_temp_id'");
        echo $yaz['tstudio']['xml_written'][$lang];
        }
    elseif ($insert_to_db!=1 and $question_type_error=="" 
        and $question_text_error=="" and $answers_error=="")
        {echo $yaz['tstudio']['xml_correct'][$lang];}
    else {echo "<span class='error'>".$yaz['tstudio']['xml_incorrect'][$lang]."</span>";}
  if ($insert_to_db!=1) 
  {  $result_delete=sql_query("delete from questions
	where question_id='$result_temp_id'"); }
echo "</td></tr> $answers_error ";

if ($answers_error=="" and $question_type_error=="" and $question_text_error=="") 
    { get_answers_from_xml($answers[0],$result_temp_id,$insert_to_db);}
elseif($answers_error=="") { get_answers_from_xml($answers[0],$result_temp_id,0);}

   }

}

function get_answers_from_xml($root,$question_id,$insert_to_db) {
global $mysql_dbname,$lang,$yaz;

$answer_nodes=$root->get_elements_by_tagname('answer'); 
foreach($answer_nodes as $answer_node)
 {
$answer_text=$answer_node->get_elements_by_tagname('answer_text'); 
$answer_sample=$answer_node->get_elements_by_tagname('sample'); 
$answer_true=$answer_node->get_elements_by_tagname('true'); 

         sql_query("insert into answers
                    (answer_id, question_id,answer_text ,answer_sample,answer_true ,true_percent )
                    values
                    ('','','','',
                    '','')
                    ");
         $result_temp_id=mysql_insert_id();

if($answer_text[0]!="") 
    {
    $text=$answer_text[0];$text_content=$text->get_content();
    $text_content=check_for_pics('answer',$result_temp_id,$text_content,$insert_to_db);
    if ($text_content=="") {$text_error="answer text absent";}
    else {$text_error="";}
    }
else {$text_error="tag ANSWER_TEXT absent";$text_content="";}

if($answer_sample[0]!="") 
    {$sample=$answer_sample[0];$sample_content=$sample->get_content();
    $sample_content=check_for_pics('answer',$result_temp_id,$sample_content,$insert_to_db);
    $sample_error="";}
else {$sample_error="tag SAMPLE absent";$sample_content="";}
if($answer_true[0]!="") 
    {$true=$answer_true[0];$true_content=$true->get_content();
    $true_error="";}
else {$true_content="";$true_error="tag TRUE absent, pass by default (0)";}


echo "<tr><td>&nbsp;&nbsp;&nbsp;</td><td>&nbsp;&nbsp;&nbsp;</td>
<td>answer text: $text_content <span class='error'>$text_error</span></td>
<td> sample: $sample_content <span class='error'>$sample_error</span></td>
<td> true: $true_content <span class='error'>$true_error</span></td>
<td>";
    if ($insert_to_db==1 and $text_error=="")
        {
                $result_insert_answer=sql_query("
        update answers set
        question_id=$question_id,answer_text='".addslashes($text_content)."',
        answer_sample='".addslashes($sample_content)."',answer_true=$true_content
        where answer_id='$result_temp_id' ");
        echo $yaz['tstudio']['xml_written'][$lang];
        }
    elseif($insert_to_db!=1 and $text_error=="")
        {
        echo $yaz['tstudio']['xml_correct'][$lang];
        }
    else {echo "<span class='error'>".$yaz['tstudio']['xml_incorrect'][$lang]."</span>";}
 if ($insert_to_db!=1) 
 { $result_delete=sql_query("delete from answers
	where answer_id='$result_temp_id'"); }
    echo "</td></tr>";
 }

}



function check_for_pics($container_code,$container_id,$text_content,$insert_to_db) {
global $mysql_dbname,$lang,$yaz;
$GLOBALS[container_id]=$container_id;
$GLOBALS[container_code]=$container_code;
$GLOBALS[temp]=!$insert_to_db;
$text_content=preg_replace_callback("/<pic>([\S]*)<\/pic>/U",'callback_insert',$text_content); 


return $text_content;
}

function callback_insert($data) {
global $mysql_dbname,$lang;

$decoded=(base64_decode($data[1]));
$tmpfilename=tempnam($GLOBALS['dirpath'], "pic");
$f_pic=fopen($tmpfilename,"wb");
fwrite($f_pic,$decoded);
fclose($f_pic);

return "<img align='absmiddle' src='".$GLOBALS['prefix']."".basename($tmpfilename)."'>";
}

function encode_xml_string($xml_content,$charset_in,$charset_out)
{
$xml_content=iconv($charset_in,$charset_out,$xml_content);
$xml_content=preg_replace("/encoding=\"(.*)\"/","encoding=\"$charset_out\" ",$xml_content);
return $xml_content;

}

function check_test_name($test_category,$test_name,$iteration=0) {
    if ($iteration!=0)
        {
        $test_name_end=$test_name."_".$iteration;
        }
    else
        {
        $test_name_end=$test_name;
        }
   $f_test=mysql_fetch_row(mysql_query("select count(*) from tests
        where
        tests.test_category_id='$test_category' and
        tests.test_name='$test_name_end'
        "));
	if ($f_test[0]>=1) {
        echo " present ";
        $iteration++;
        $test_name_end=check_test_name($test_category,$test_name,$iteration);
        return $test_name_end;
	} else {
		return $test_name_end;
    }

}