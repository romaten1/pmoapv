<?php
if (INDEXPHP!=1) die ("You can't access this file directly...");

	// получаем, определяем и проверяем входяшие данные
	if(!isset($_REQUEST['page_num']))
	  $page_num=0;
	else
	  $page_num=intval($_REQUEST['page_num']-1);

	if(!isset($_REQUEST['letter']))
	  $letter="";
	else
	  $letter=$_REQUEST['letter'];

	if(!isset($_REQUEST['keyword']))
	  $keyword="";
	else
	  $keyword=$_REQUEST['keyword'];	

	if(!isset($_REQUEST['test_category_id']))
		  $test_category_id="";
	else
		  $test_category_id=intval($_REQUEST['test_category_id']);

	themeleftbox(_TEST_CHOOSE_HEADER,"","",true);

	echo "<tr><td><br>";
	
	if ($keyword!='')
	{	
		$null_message = TEST_NO_T_KEYWORD;
	}
	elseif ($letter=='')
	{
		$null_message = _TEST_NO_TEST;
	}
	else
	{	
		$null_message = _TEST_NO_T_LETTER;
	}	
	$count = get_count($test_category_id,5,false,$keyword,$letter);	

	// Вывод алфавита
	show_abc('index.php?module='.$module.'&page='.$page.'&group_id='.$group_id.'&test_id='.$test_id.'&test_category_id='.$test_category_id.'&letter=');

	if ($count==0)
		echo "<center><b>".$null_message."</b></center>";
	else
	{
		CloseTable();

		// выводим список тестов в данной категории...
		if ($keyword!='')
			$query="SELECT DISTINCT test_id,test_name,test_disable
					   FROM tests t, permissions p
					   WHERE t.test_category_id='".$test_category_id."'
						AND t.test_name RLIKE '.*".$keyword.".*'		
							AND ((p.object_code=11 AND p.object_id='".$test_category_id."') OR (p.object_code=12 AND p.object_id=t.test_id ))
								 AND (p.user_id='".$GLOBALS['auth_result']['user']['user_id']."'
								 		OR p.group_id='".$GLOBALS['auth_result']['user']['group_id']."'
								 		OR p.group_category_id='".$GLOBALS['auth_result']['group']['group_category_id']."')
								 AND (p.permission_read=1 OR p.permission_write=1 OR p.permission_owner=1)				
					   ORDER BY t.test_name ASC
					   LIMIT ".$page_num*$limit_page.",".$limit_page;
		else
			if ($letter=='')
				$query="SELECT DISTINCT  test_id,test_name,test_disable
					   FROM tests t, permissions p
					   WHERE t.test_category_id='".$test_category_id."'		
					   
					   			AND ((p.object_code=11 AND p.object_id='".$test_category_id."') OR (p.object_code=12 AND p.object_id=t.test_id ))
								 AND (p.user_id='".$GLOBALS['auth_result']['user']['user_id']."'
								 		OR p.group_id='".$GLOBALS['auth_result']['user']['group_id']."'
								 		OR p.group_category_id='".$GLOBALS['auth_result']['group']['group_category_id']."')
								 AND (p.permission_read=1 OR p.permission_write=1 OR p.permission_owner=1)
								 				
					   ORDER BY t.test_name ASC
					   LIMIT ".$page_num*$limit_page.",".$limit_page;
			else
				$query="SELECT DISTINCT  test_id,test_name,test_disable
					   FROM tests t, permissions p
					   WHERE t.test_category_id='".$test_category_id."'
						AND t.test_name RLIKE '^".$letter.".*'			
						
								AND ((p.object_code=11 AND p.object_id='".$test_category_id."') OR (p.object_code=12 AND p.object_id=t.test_id ))
								 AND (p.user_id='".$GLOBALS['auth_result']['user']['user_id']."'
								 		OR p.group_id='".$GLOBALS['auth_result']['user']['group_id']."'
								 		OR p.group_category_id='".$GLOBALS['auth_result']['group']['group_category_id']."')
								 AND (p.permission_read=1 OR p.permission_write=1 OR p.permission_owner=1)
									
					   ORDER BY t.test_name ASC
					   LIMIT ".$page_num*$limit_page.",".$limit_page;
		$result=sql_query($query);

		$n=0;

		$col_width=100/$limit_col;

		$page_buf = '<table border="0"style="width:100%"><tr><td width='.$col_width.'%>';
		while ($row=mysql_fetch_assoc($result))
		{
			if ($n==$limit_row)
				{
					 $page_buf .= "<td width=".$col_width."%>";
					 $n=0;

				}
			$n++;

		   $page_buf .= "<table cellpadding=0 cellspacing=0 border=".$config['debug_table'].">
						<tr><td nowrap>
						<a href='index.php?module=".$module."&page=editing&action=add_new_test&group_id=".$group_id."&test_category_id=".$test_category_id."&test_id=".$test_id."&new_test_id=".$row['test_id']."'><img title='"._TEST_CHOOSE_TEST."' align='absmiddle' src='themes/".$current_theme."/images/view.png'></a>
						</td><td>
						&nbsp;".($row['test_disable']==1?"<font color=#bbbbbb>":"").$row['test_name'].($row['test_disable']==1?"</font>":"")."
						</td></tr></table>";
		}
	    $page_buf .= "<tr><td colspan=".$limit_col."><br>";
		echo $page_buf.nav_bar($count,"index.php?module=".$module."&page=".$page."&group_id=".$group_id."&test_id=".$test_id."&test_category_id=".$test_category_id."&letter=".$letter."&page_num=");
	}
?>