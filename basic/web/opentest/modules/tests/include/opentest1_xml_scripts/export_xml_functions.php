<?
function export_xml ($xml_type,$test_id='',$topic_id='',$question_id='') {
global $opentest_dir_offset;
//создание объекта DOM XML
$xml = join("",file("xmls/export_template.xml"));
$dom=domxml_open_mem($xml);
switch ($xml_type)
	{
	case 'test':{$root=$dom->add_root("test");export_test($dom,$root,$test_id);break;}
	case 'topic':{$root=$dom->add_root("topics");export_topic($dom,$root,$topic_id);break;}
	case 'question':{$root=$dom->add_root("questions");export_question($dom,$root,$question_id);break;}
	}	
//пишем полученны dom-объект в файл. ЗАМЕЧАНИЕ: в dump_file указывается путь относительно каталога system32 !!! - это глюк (фича) разработчиков ПХП

$out_dir="$_SERVER[DOCUMENT_ROOT]/".$opentest_dir_offset."modules/TestStudio/xmls/_temp.xml";
$str=$dom->dump_mem(true,"utf-8");
$root->unlink_node();

return $str;
}

function export_test(&$dom,&$root,$test_id) {
global $mysql_dbname;
// достаем имя тeста по его id
$result_test=mysql_db_query($mysql_dbname,"select * from tests where test_id=$test_id");
if (mysql_num_rows($result_test)==0) 
	{echo $yaz['tstudio']['xml_no_test_in_db'][$lang];}
else 
	{
	$fetched_test=mysql_fetch_array($result_test);
	$name_text=iconv("Windows-1251","utf-8",$fetched_test[test_name]);
	$test_name_text=$dom->create_text_node($name_text);
	$test_name=$dom->create_element("test_name");
	$test_name->append_child($test_name_text);
	$test_name=$root->append_child($test_name);
	//создаем элемент topics
	$topics_root=$dom->create_element("topics");
	$topics_root=$root->append_child($topics_root);
	// нахождение всех тем данного теста
	$result_topics=mysql_db_query($mysql_dbname,"select topic_id from topics where test_id=$test_id");
	while ($fetched_topic=mysql_fetch_array($result_topics))
		{
		//вызов функции добавления тем в элемент $topics_root
		export_topic($dom,$topics_root,$fetched_topic[topic_id]);
		}
	mysql_free_result($result_topics);
	}
mysql_free_result($result_test);
}

//----------------------------------------------------------------------------

function export_topic(&$dom,&$root,&$topic_id) 
{ global $mysql_dbname;
$topic=$dom->create_element("topic");
$topic=$root->append_child($topic);	
$result_topic=mysql_db_query($mysql_dbname,"select * from topics where topic_id=$topic_id");
$fetched_topic=mysql_fetch_array($result_topic);
	$topic_name=$dom->create_element("topic_name");
	$name_text=iconv("Windows-1251","utf-8",$fetched_topic[topic_name]);
	$topic_name_text=$dom->create_text_node($name_text);
	$topic_name->append_child($topic_name_text);	
	$topic_name=$topic->append_child($topic_name);
	//создаем элемент questions
	$questions_root=$dom->create_element("questions");
	$questions_root=$topic->append_child($questions_root);
	// нахождение всех вопросов данного теста
	$result_questions=mysql_db_query($mysql_dbname,"select question_id from questions where topic_id=$topic_id");
	while ($fetched_question=mysql_fetch_array($result_questions))
		{
		//вызов функции добавления вопросов в элемент $questions_root
		export_question($dom,$questions_root,$fetched_question[question_id]);
		}
mysql_free_result($result_questions);
mysql_free_result($result_topic);
}

//----------------------------------------------------------------------------

function export_question(&$dom,&$root,&$question_id) 
{global $mysql_dbname;
$question=$dom->create_element("question");
$question=$root->append_child($question);	
$result_question=mysql_db_query($mysql_dbname,"select * from questions where question_id=$question_id");
$fetched_question=mysql_fetch_array($result_question);
	$question_text=$dom->create_element("question_text");
	$question_type=$dom->create_element("question_type");
	
	$q_text=flush_images(iconv("Windows-1251","utf-8",$fetched_question[question_text]));
	$question_text_content=$dom->create_text_node($q_text);
	$question_text->append_child($question_text_content);	
	$question_text=$question->append_child($question_text);
	$question_type_content=$dom->create_text_node($fetched_question[question_type]);
	$question_type->append_child($question_type_content);	
	$question_type=$question->append_child($question_type);
	
	$question->set_attribute("delayed",$fetched_question[show_answers_later]);

	//создаем элемент answers
	$answers_root=$dom->create_element("answers");
	$answers_root=$question->append_child($answers_root);
	// нахождение всех ответов данного теста
	$result_answers=mysql_db_query($mysql_dbname,"select answer_id from answers where question_id=$question_id");
	while ($fetched_answer=mysql_fetch_array($result_answers))
		{
		//вызов функции добавления ответов в элемент $answers_root
		export_answer($dom,$answers_root,$fetched_answer[answer_id]);
		}
mysql_free_result($result_answers);
mysql_free_result($result_question);
}

//----------------------------------------------------------------------------

function export_answer(&$dom,&$root,&$answer_id) 
{global $mysql_dbname;
$answer=$dom->create_element("answer");
$answer=$root->append_child($answer);	
$result_answer=mysql_db_query($mysql_dbname,"select * from answers where answer_id=$answer_id");
$fetched_answer=mysql_fetch_array($result_answer);
	$answer_text=$dom->create_element("answer_text");
	$answer_sample=$dom->create_element("sample");
	$answer_true=$dom->create_element("true");
	
	$a_text=flush_images(iconv("Windows-1251","utf-8",$fetched_answer[answer_text]));
	$a_sample=flush_images(iconv("Windows-1251","utf-8",$fetched_answer[answer_sample]));
	
	$answer_text_content=$dom->create_text_node($a_text);
	$answer_text->append_child($answer_text_content);	
	$answer_text=$answer->append_child($answer_text);
	
	$answer_sample_content=$dom->create_text_node($a_sample);
	$answer_sample->append_child($answer_sample_content);	
	$answer_sample=$answer->append_child($answer_sample);
	
	$answer_true_content=$dom->create_text_node($fetched_answer[answer_true]);
	$answer_true->append_child($answer_true_content);	
	$answer_true=$answer->append_child($answer_true);
mysql_free_result($result_answer);	
}

//-----------------------------------------------------------

function flush_images($string)
{
// находим картинки в тексте
$string=preg_replace_callback("/<img\s*.*src='view.php\?id=(\d*)'.*>/U",'callback_flush',$string); 
return $string;
}

function callback_flush($data) {
global $mysql_dbname;
$result_pic=mysql_db_query($mysql_dbname,"select * from binary_data where binary_data_id=$data[1]");
$fetched_pic=mysql_fetch_array($result_pic);
return " <pic>".base64_encode($fetched_pic[data_content])."</pic> ";

}

function encode_xml_string($xml_content,$charset_in,$charset_out)
{
$xml_content=iconv($charset_in,$charset_out,$xml_content);
$xml_content=preg_replace("/encoding=\"(.*)\"/","encoding=\"$charset_out\"",$xml_content);
return $xml_content;

}