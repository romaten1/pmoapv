<?
include("./../conf/opentest.conf");
ignore_user_abort();
ini_set ("max_execution_time","16000");
mysql_selectdb($mysql_dbname);



switch($_POST[go])
	{
	case "1":
		{
		$file=fopen($_FILES[users_file][tmp_name],"r");
		$count=0;
		echo "<span style='font-size:10px;font-family:verdana;'>";
		
		mysql_query("delete from tmp_users");
         while($pr_row=fgets($file) )
                {
				$count++;
				//echo $count."<br>";

                $pr_row=str_replace("\n","",$pr_row);
                $pr_row=str_replace("\r","",$pr_row);
                $row=csv_split($pr_row,";");
				
				
				
				$res_ins=mysql_query("insert into tmp_users
					(tmp_user_id,facultet ,user_name , group_name ,col1 )
				   values
				   ('', '".addslashes($row[0])."','".addslashes($row[1])."','_".addslashes($row[2])."','".addslashes($row[3])."')
								");
				
								

                //print_r($row);
                //echo "<br>";
                }
		echo "<p>Found   $count users in CSV file </p>";
		
		// processing groups:
		echo " ---------------------- processing groups ----------------------  <br>";
		
		
		
		$res_tmp_groups=mysql_query("select distinct group_name from tmp_users");
		while ($f_tmp_group=mysql_fetch_array($res_tmp_groups))
			{
			echo "<br> <b> processing group \"".$f_tmp_group[group_name]."\" </b>";
			$res_local_group=mysql_query("select * from groups where group_name='$f_tmp_group[group_name]' ");
			if (mysql_num_rows($res_local_group)>=1)
				{
				
				$f_local_group=mysql_fetch_array($res_local_group);
				echo "<dd> <span style='color:green'>Local group found. Disabling all users </span>";
				$res_users_in_group=mysql_query("select * from users,object_relation
						where users.user_id=object_relation.object_id and
						object_relation.in_object_id='{$f_local_group[group_id]}' and
						object_relation.relation_type=0
					");
				while ($f_user_in_group=mysql_fetch_array($res_users_in_group))
					{
					mysql_query("update users set disabled='1' where user_id='$f_user_in_group[user_id]' ");
					}
				
				
				echo "<dd> ---------- processing users in group $f_local_group[group_name] ---------";				
				$res_tmp_users=mysql_query("select * from tmp_users where group_name='$f_tmp_group[group_name]' ");
				while($f_tmp_user=mysql_fetch_array($res_tmp_users))
					{
					$test_local_user=mysql_query("select users.* from users,object_relation
							where users.user_id=object_relation.object_id and
								object_relation.in_object_id='{$f_local_group[group_id]}' and
								object_relation.relation_type=0 and
								users.user_name='$f_tmp_user[user_name]'
							");
					if (mysql_num_rows($test_local_user)>=1)
						{
						$f_test_local_user=mysql_fetch_array($test_local_user);
						echo "<dd> updatig user $f_tmp_user[user_name] ";
						mysql_query(" update users set disabled=0 where user_id='{$f_test_local_user[user_id]}' ");
						}
					else
						{
						echo "<dd> adding user $f_tmp_user[user_name] ";
						mysql_query("insert into users
							(user_id, user_name ,user_login ,user_password , last_log_date ,disabled )
							values
							('','$f_tmp_user[user_name]','','','','0')
							");
						$local_user_id=mysql_insert_id();
						mysql_query("insert into object_relation  
							(object_relation_id,object_id,in_object_id ,relation_type )
							values
							('','$local_user_id','$f_local_group[group_id]','0')
						");
						
						
						
						
						}
					
					
					}
				set_permissions(array(0=>$f_local_group[group_id]));
				}
			else
				{
				echo "<dd> <span style='color:red'>Local group not found. Creating local group </span>";
				mysql_query("insert into groups 
						(group_id,group_name)
						values
						('','$f_tmp_group[group_name]')
					");
				echo "<dd> Local group \"$f_tmp_group[group_name]\" has been created ";
				$local_group_id=mysql_insert_id();
				$res_tmp_users=mysql_query("select * from tmp_users where group_name='$f_tmp_group[group_name]' ");
				while($f_tmp_user=mysql_fetch_array($res_tmp_users))
					{
					mysql_query("insert into users
							(user_id, user_name ,user_login ,user_password , last_log_date ,disabled )
							values
							('','$f_tmp_user[user_name]','','','','0')
												");
					$local_user_id=mysql_insert_id();
					mysql_query("insert into object_relation  
							(object_relation_id,object_id,in_object_id ,relation_type )
							values
							('','$local_user_id','$local_group_id','0')
						");
					echo "<dd> User \"$f_tmp_user[user_name]\" added to local group $f_tmp_group[group_name]";
					}
				set_permissions(array(0=>$local_group_id));
				}
			
			}
		
		
		break;
		}
	default:
		{
		echo "
			<form method=post enctype='multipart/form-data'>
					<input type=hidden name='go' value='1'>
				CSV File: <input type=file name='users_file'> <br>
				<input type=submit>
			</form>
			";
		}
	}












function csv_split($line,$delim=',',$removeQuotes=false) {
#$line: the csv line to be split
#$delim: the delimiter to split by
#$removeQuotes: if this is false, the quotation marks won't be removed from the fields
   $fields = array();
   $fldCount = 0;
   $inQuotes = false;
   for ($i = 0; $i < strlen($line); $i++) {
       if (!isset($fields[$fldCount])) $fields[$fldCount] = "";
       $tmp = substr($line,$i,strlen($delim));
       if ($tmp === $delim && !$inQuotes) {
           $fldCount++;
           $i += strlen($delim)-1;
       } else if ($fields[$fldCount] == "" && $line[$i] == '"' && !$inQuotes) {
           if (!$removeQuotes) $fields[$fldCount] .= $line[$i];
           $inQuotes = true;
       } else if ($line[$i] == '"') {
           if ($line[$i+1] == '"') {
               $i++;
               $fields[$fldCount] .= $line[$i];
           } else {
               if (!$removeQuotes) $fields[$fldCount] .= $line[$i];
               $inQuotes = false;
           }
       } else {
           $fields[$fldCount] .= $line[$i];
       }
   }
   return $fields;
}







function set_permissions($primary_groups)
	{
	global $mysql_dbname;
	$secondary_group='3';
	
	// какие права передавать
	$permission_owner=0;
	
	mysql_selectdb($mysql_dbname);
	
	
	foreach($primary_groups as $primary_group)
	  {
	  echo $primary_group." ";
	  $res_users=mysql_query("select * from object_relation where
			  relation_type=0 and
			  in_object_id='$secondary_group'
			  ");
	  while ($f_user=mysql_fetch_array($res_users))
		{
		$res_check_exists=mysql_query("select * from permissions where
				  object_code='21' and
				  object_id='$primary_group' and
				  user_id='$f_user[object_id]' and
				  group_id='$secondary_group'
				  ");
	
		if (mysql_num_rows($res_check_exists)<=0)
		  {
		  mysql_query("insert into permissions
			(permission_id, object_code, object_id,user_id, group_id,
			permission_read, permission_write, permission_execute,
	permission_modify, permission_owner)
			values
			('', '21', '$primary_group','$f_user[object_id]', '$secondary_group',
			'', '', '', '', '$permission_owner')
				  ");
		  }
		else
		  {
		mysql_query("update permissions
				  set
				  permission_read=0,
				  permission_owner='$permission_owner'
				  where
				  object_code='21' and
				  object_id='$primary_group' and
				  user_id='$f_user[object_id]' and
				  group_id='$secondary_group'
				  ");
		  }
		}
	
	
	
	  }
		
		
		
	}





?>